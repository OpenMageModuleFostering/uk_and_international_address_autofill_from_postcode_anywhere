<script type="text/javascript">
//<![CDATA[
    (function() {
        var magentoFields = [
            {
                Company: "order-billing_address_company",
                Line1: "order-billing_address_street0",
                Line2: "order-billing_address_street1",
                City: "order-billing_address_city",
                State: "order-billing_address_region",
                StateSelect: "order-billing_address_region_id",
                Postcode: "order-billing_address_postcode",
                CountrySelect: "order-billing_address_country_id"
            },
            {
                Company: "order-shipping_address_company",
                Line1: "order-shipping_address_street0",
                Line2: "order-shipping_address_street1",
                City: "order-shipping_address_city",
                State: "order-shipping_address_region",
                StateSelect: "order-shipping_address_region_id",
                Postcode: "order-shipping_address_postcode",
                CountrySelect: "order-shipping_address_country_id"
            },
            {
                Company: "company",
                Line1: "street0",
                Line2: "street1",
                City: "city",
                State: "region",
                StateSelect: "region_id",
                Postcode: "postcode",
                CountrySelect: "country_id"
            }
        ],
        key = '<?php echo Mage::getStoreConfig('captureplus/settings/admin_key'); ?>';
    
        function load() {
            function createAddressControl(addressFields) {
                var countryField = pca.getElement(addressFields.CountrySelect); 
                    magentoCountries = [];
                
                for (var c = 0; c < countryField.options.length; c++)
                    magentoCountries.push(countryField.options[c].value);
            
                var fields = [
                    { element: addressFields.Company, field: "Company", mode: pca.fieldMode.DEFAULT | pca.fieldMode.PRESERVE },
                    { element: addressFields.Line1, field: "Line1" },
                    { element: addressFields.Line2, field: "Line2", mode: pca.fieldMode.POPULATE },
                    { element: addressFields.City, field: "City", mode: pca.fieldMode.POPULATE },
                    { element: addressFields.State, field: "ProvinceName", mode: pca.fieldMode.POPULATE },
                    { element: addressFields.StateSelect, field: "ProvinceName", mode: pca.fieldMode.POPULATE },
                    { element: addressFields.Postcode, field: "PostalCode" },
                    { element: addressFields.CountrySelect, field: "CountryIso2", mode: pca.fieldMode.COUNTRY }
                ],
                options = { 
                    key: key,
                    suppressAutocomplete: true,
                    countries: { 
                        codesList: magentoCountries.join(","), 
                        valueType: pca.countryNameType.ISO2 
                    },
                    source: "magento-admin"
                },
                control = new pca.Address(fields, options);        
                
                control.listen("populate", function() {
                    for (var i in addressFields)
                      pca.fire(pca.getElement(addressFields[i]), "change");
                });
            }
    
            for (var i = 0; i < magentoFields.length; i++) {
                if (pca.getElement(magentoFields[i].Line1))
                    createAddressControl(magentoFields[i]);
            }
            
            //customer edit dynamic addresses
            if (typeof customerAddresses != 'undefined') {
                var addNewAddressFunction = customerAddresses.addNewAddress.bind(customerAddresses);

                customerAddresses.addNewAddress = function () {
                    addNewAddressFunction();
                    
                    var newAddressIndex = customerAddresses.itemCount;

                    if (pca.getElement("_item" + newAddressIndex + "street0")) {
                        createAddressControl({
                            Company: "_item" + newAddressIndex + "company",
                            Line1: "_item" + newAddressIndex + "street0",
                            Line2: "_item" + newAddressIndex + "street1",
                            City: "_item" + newAddressIndex + "city",
                            State: "_item" + newAddressIndex + "region",
                            StateSelect: "_item" + newAddressIndex + "region_id",
                            Postcode: "_item" + newAddressIndex + "postcode",
                            CountrySelect: "_item" + newAddressIndex + "country_id"
                        });
                    }
                }
                
                //launch for existing addresses
                for (var i = 1; i <= customerAddresses.itemCount; i++) {
                    if (pca.getElement("_item" + i + "street0")) {
                        createAddressControl({
                            Company: "_item" + i + "company",
                            Line1: "_item" + i + "street0",
                            Line2: "_item" + i + "street1",
                            City: "_item" + i + "city",
                            State: "_item" + i + "region",
                            StateSelect: "_item" + i + "region_id",
                            Postcode: "_item" + i + "postcode",
                            CountrySelect: "_item" + i + "country_id"
                        });
                    }
                }
            }
        }
        
        window.reloadCapturePlus = load;
        pca.fuzzyMatch = false;
        pca.ready(load);
    })();
//]]>
</script>
